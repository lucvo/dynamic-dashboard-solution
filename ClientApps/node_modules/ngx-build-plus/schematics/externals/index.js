"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const schematics_1 = require("@angular-devkit/schematics");
const config_1 = require("@schematics/angular/utility/config");
const path = require("path");
const tasks_1 = require("@angular-devkit/schematics/tasks");
const SCRIPTS = [
    "node_modules/rxjs/bundles/rxjs.umd.js",
    "node_modules/@angular/core/bundles/core.umd.js",
    "node_modules/@angular/common/bundles/common.umd.js",
    "node_modules/@angular/common/bundles/common-http.umd.js",
    "node_modules/@angular/compiler/bundles/compiler.umd.js",
    "node_modules/@angular/elements/bundles/elements.umd.js",
    "node_modules/@angular/platform-browser/bundles/platform-browser.umd.js",
    "node_modules/@angular/platform-browser-dynamic/bundles/platform-browser-dynamic.umd.js"
];
function addExternalsSupport(_options) {
    return (tree, _context) => {
        const project = getProject(tree, _options);
        const relProjectRootPath = project.root.replace(/[^\/]+/g, '..') || '';
        updatePackageJson(project.root || '', tree, _options, _context);
        const templateSource = schematics_1.apply(schematics_1.url('./files'), [
            schematics_1.template(Object.assign(Object.assign({}, _options), { relProjectRootPath, projectRoot: project.root || '' })),
            schematics_1.move(project.root || '/')
        ]);
        return schematics_1.chain([
            addScriptsToProject(tree, _options),
            schematics_1.mergeWith(templateSource),
        ]);
    };
}
exports.addExternalsSupport = addExternalsSupport;
function updatePackageJson(path, tree, _options, _context) {
    const config = loadPackageJson(tree);
    updateScripts(path, config, tree, _options, _context);
    savePackageJson(config, tree);
}
function addScriptsToProject(tree, options) {
    const workspace = config_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    if (!project.architect || !project.architect.build || !project.architect.build.options) {
        return schematics_1.noop();
    }
    const buildOptions = project.architect.build.options;
    if (!buildOptions)
        return schematics_1.noop();
    if (!buildOptions.scripts) {
        buildOptions.scripts = [];
    }
    const scripts = buildOptions.scripts;
    SCRIPTS
        .filter(s => !scripts.includes(s))
        .forEach(script => {
        scripts.push(script);
    });
    return config_1.updateWorkspace(workspace);
}
function getProject(tree, options) {
    const workspace = config_1.getWorkspace(tree);
    if (!options.project) {
        options.project = Object.keys(workspace.projects)[0];
    }
    const project = workspace.projects[options.project];
    // compensate for lacking sourceRoot property
    // e. g. when project was migrated to ng7, sourceRoot is lacking
    if (!project.sourceRoot && !project.root) {
        project.sourceRoot = 'src';
    }
    else if (!project.sourceRoot) {
        project.sourceRoot = path.join(project.root, 'src');
    }
    return project;
}
function savePackageJson(config, tree) {
    const newContentAsString = JSON.stringify(config, null, 2) || '';
    tree.overwrite('package.json', newContentAsString);
}
function loadPackageJson(tree) {
    const pkg = tree.read('package.json');
    if (pkg === null)
        throw Error('could not read package.json');
    const contentAsString = pkg.toString('UTF-8');
    const config = JSON.parse(contentAsString);
    return config;
}
function updateScripts(path, config, tree, _options, _context) {
    const project = getProject(tree, _options);
    if (path)
        path += '/';
    if (!config['scripts']) {
        config.scripts = {};
    }
    let additionalFlags = '';
    // Ivy support
    const postInstall = config.scripts['postinstall'] || '';
    //if (postInstall.startsWith('ngcc')) {
    config.scripts['postinstall:bak'] = postInstall;
    config.scripts['postinstall'] = 'ngcc';
    _context.addTask(new tasks_1.RunSchematicTask('npmRun', { script: 'postinstall' }));
    //} 
    if (!_options.host) {
        // external web components need single bundle 
        additionalFlags = '--single-bundle';
    }
    // Heuristic for default project
    if (!project.root) {
        config.scripts['build:externals'] = `ng build --extra-webpack-config ${path}webpack.externals.js --prod ${additionalFlags}`;
    }
    if (_options.project) {
        config.scripts[`build:${_options.project}:externals`] = `ng build --extra-webpack-config ${path}webpack.externals.js --prod --project ${_options.project} ${additionalFlags}`;
    }
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiaW5kZXguanMiLCJzb3VyY2VSb290IjoiLi8iLCJzb3VyY2VzIjpbInNjaGVtYXRpY3MvZXh0ZXJuYWxzL2luZGV4LnRzIl0sIm5hbWVzIjpbXSwibWFwcGluZ3MiOiI7O0FBQUEsMkRBQThJO0FBQzlJLCtEQUFtRjtBQUNuRiw2QkFBNkI7QUFJN0IsNERBQW9FO0FBR3BFLE1BQU0sT0FBTyxHQUFHO0lBQ2QsdUNBQXVDO0lBQ3ZDLGdEQUFnRDtJQUNoRCxvREFBb0Q7SUFDcEQseURBQXlEO0lBQ3pELHdEQUF3RDtJQUN4RCx3REFBd0Q7SUFDeEQsd0VBQXdFO0lBQ3hFLHdGQUF3RjtDQUN6RixDQUFDO0FBRUYsU0FBZ0IsbUJBQW1CLENBQUMsUUFBYTtJQUMvQyxPQUFPLENBQUMsSUFBVSxFQUFFLFFBQTBCLEVBQUUsRUFBRTtRQUVoRCxNQUFNLE9BQU8sR0FBRyxVQUFVLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBQzNDLE1BQU0sa0JBQWtCLEdBQUcsT0FBTyxDQUFDLElBQUksQ0FBQyxPQUFPLENBQUMsU0FBUyxFQUFFLElBQUksQ0FBQyxJQUFJLEVBQUUsQ0FBQztRQUV2RSxpQkFBaUIsQ0FBQyxPQUFPLENBQUMsSUFBSSxJQUFJLEVBQUUsRUFBRSxJQUFJLEVBQUUsUUFBUSxFQUFFLFFBQVEsQ0FBQyxDQUFDO1FBRWhFLE1BQU0sY0FBYyxHQUFHLGtCQUFLLENBQUMsZ0JBQUcsQ0FBQyxTQUFTLENBQUMsRUFBRTtZQUMzQyxxQkFBUSxpQ0FBSyxRQUFRLEtBQUUsa0JBQWtCLEVBQUUsV0FBVyxFQUFFLE9BQU8sQ0FBQyxJQUFJLElBQUksRUFBRSxJQUFFO1lBQzVFLGlCQUFJLENBQUMsT0FBTyxDQUFDLElBQUksSUFBSSxHQUFHLENBQUM7U0FDMUIsQ0FBQyxDQUFDO1FBRUgsT0FBTyxrQkFBSyxDQUFDO1lBQ1QsbUJBQW1CLENBQUMsSUFBSSxFQUFFLFFBQVEsQ0FBQztZQUNuQyxzQkFBUyxDQUFDLGNBQWMsQ0FBQztTQUM1QixDQUFDLENB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QUFDLE1BQU0sRUFBRSxhQUFhLEVBQUMsQ0FBQyxDQUFDLENBQUM7SUFDNUUsSUFBSTtJQUVKLElBQUksQ0FBQyxRQUFRLENBQUMsSUFBSSxFQUFFO1FBQ2xCLDhDQUE4QztRQUM5QyxlQUFlLEdBQUcsaUJBQWlCLENBQUM7S0FDckM7SUFFRCxnQ0FBZ0M7SUFDaEMsSUFBSSxDQUFDLE9BQU8sQ0FBQyxJQUFJLEVBQUU7UUFDakIsTUFBTSxDQUFDLE9BQU8sQ0FBQyxpQkFBaUIsQ0FBQyxHQUFHLG1DQUFtQyxJQUFJLCtCQUErQixlQUFlLEVBQUUsQ0FBQztLQUM3SDtJQUVELElBQUksUUFBUSxDQUFDLE9BQU8sRUFBRTtRQUNwQixNQUFNLENBQUMsT0FBTyxDQUFDLFNBQVMsUUFBUSxDQUFDLE9BQU8sWUFBWSxDQUFDLEdBQUcsbUNBQW1DLElBQUkseUNBQXlDLFFBQVEsQ0FBQyxPQUFPLElBQUksZUFBZSxFQUFFLENBQUM7S0FDL0s7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHsgUnVsZSwgU2NoZW1hdGljQ29udGV4dCwgVHJlZSwgYXBwbHksIHVybCwgdGVtcGxhdGUsIG1vdmUsIGJyYW5jaEFuZE1lcmdlLCBtZXJnZVdpdGgsIGNoYWluLCBub29wIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L3NjaGVtYXRpY3MnO1xyXG5pbXBvcnQgeyBnZXRXb3Jrc3BhY2UsIHVwZGF0ZVdvcmtzcGFjZSB9IGZyb20gJ0BzY2hlbWF0aWNzL2FuZ3VsYXIvdXRpbGl0eS9jb25maWcnO1xyXG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gJ3BhdGgnO1xyXG5pbXBvcnQgeyBCcm93c2VyQnVpbGRlckJhc2VPcHRpb25zIH0gZnJvbSAnQHNjaGVtYXRpY3MvYW5ndWxhci91dGlsaXR5L3dvcmtzcGFjZS1tb2RlbHMnO1xyXG5pbXBvcnQgeyBBZHZhbmNlZFNjcmlwdENvbmYgfSBmcm9tICcuLi91dGlscy90eXBlcyc7XHJcbmltcG9ydCB7IHNwYXduIH0gZnJvbSAnY3Jvc3Mtc3Bhd24nO1xyXG5pbXBvcnQgeyBSdW5TY2hlbWF0aWNUYXNrIH0gZnJvbSAnQGFuZ3VsYXItZGV2a2l0L3NjaGVtYXRpY3MvdGFza3MnO1xyXG5cclxuXHJcbmNvbnN0IFNDUklQVFMgPSBbXHJcbiAgXCJub2RlX21vZHVsZXMvcnhqcy9idW5kbGVzL3J4anMudW1kLmpzXCIsXHJcbiAgXCJub2RlX21vZHVsZXMvQGFuZ3VsYXIvY29yZS9idW5kbGVzL2NvcmUudW1kLmpzXCIsXHJcbiAgXCJub2RlX21vZHVsZXMvQGFuZ3VsYXIvY29tbW9uL2J1bmRsZXMvY29tbW9uLnVtZC5qc1wiLFxyXG4gIFwibm9kZV9tb2R1bGVzL0Bhbmd1bGFyL2NvbW1vbi9idW5kbGVzL2NvbW1vbi1odHRwLnVtZC5qc1wiLFxyXG4gIFwibm9kZV9tb2R1bGVzL0Bhbmd1bGFyL2NvbXBpbGVyL2J1bmRsZXMvY29tcGlsZXIudW1kLmpzXCIsXHJcbiAgXCJub2RlX21vZHVsZXMvQGFuZ3VsYXIvZWxlbWVudHMvYnVuZGxlcy9lbGVtZW50cy51bWQuanNcIixcclxuICBcIm5vZGVfbW9kdWxlcy9AYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyL2J1bmRsZXMvcGxhdGZvcm0tYnJvd3Nlci51bWQuanNcIixcclxuICBcIm5vZGVfbW9kdWxlcy9AYW5ndWxhci9wbGF0Zm9ybS1icm93c2VyLWR5bmFtaWMvYnVuZGxlcy9wbGF0Zm9ybS1icm93c2VyLWR5bmFtaWMudW1kLmpzXCJcclxuXTtcclxuXHJcbmV4cG9ydCBmdW5jdGlvbiBhZGRFeHRlcm5hbHNTdXBwb3J0KF9vcHRpb25zOiBhbnkpOiBSdWxlIHtcclxuICByZXR1cm4gKHRyZWU6IFRyZWUsIF9jb250ZXh0OiBTY2hlbWF0aWNDb250ZXh0KSA9PiB7XHJcblxyXG4gICAgY29uc3QgcHJvamVjdCA9IGdldFByb2plY3QodHJlZSwgX29wdGlvbnMpO1xyXG4gICAgY29uc3QgcmVsUHJvamVjdFJvb3RQYXRoID0gcHJvamVjdC5yb290LnJlcGxhY2UoL1teXFwvXSsvZywgJy4uJykgfHwgJyc7XHJcblxyXG4gICAgdXBkYXRlUGFja2FnZUpzb24ocHJvamVjdC5yb290IHx8ICcnLCB0cmVlLCBfb3B0aW9ucywgX2NvbnRleHQpO1xyXG5cclxuICAgIGNvbnN0IHRlbXBsYXRlU291cmNlID0gYXBwbHkodXJsKCcuL2ZpbGVzJyksIFtcclxuICAgICAgdGVtcGxhdGUoey4uLl9vcHRpb25zLCByZWxQcm9qZWN0Um9vdFBhdGgsIHByb2plY3RSb290OiBwcm9qZWN0LnJvb3QgfHwgJyd9KSxcclxuICAgICAgbW92ZShwcm9qZWN0LnJvb3QgfHwgJy8nKVxyXG4gICAgXSk7XHJcblxyXG4gICAgcmV0dXJuIGNoYWluKFtcclxuICAgICAgICBhZGRTY3JpcHRzVG9Qcm9qZWN0KHRyZWUsIF9vcHRpb25zKSxcclxuICAgICAgICBtZXJnZVdpdGgodGVtcGxhdGVTb3VyY2UpLFxyXG4gICAgXSk7XHJcblxyXG4gIH1cclxuICBcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlUGFja2FnZUpzb24ocGF0aDogc3RyaW5nLCB0cmVlOiBUcmVlLCBfb3B0aW9uczogYW55LCBfY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkge1xyXG4gIGNvbnN0IGNvbmZpZyA9IGxvYWRQYWNrYWdlSnNvbih0cmVlKTtcclxuICB1cGRhdGVTY3JpcHRzKHBhdGgsIGNvbmZpZywgdHJlZSwgX29wdGlvbnMsIF9jb250ZXh0KTtcclxuICBzYXZlUGFja2FnZUpzb24oY29uZmlnLCB0cmVlKTtcclxufVxyXG5cclxuZnVuY3Rpb24gYWRkU2NyaXB0c1RvUHJvamVjdCh0cmVlOiBUcmVlLCBvcHRpb25zOiBhbnkpOiBSdWxlIHtcclxuICBjb25zdCB3b3Jrc3BhY2UgPSBnZXRXb3Jrc3BhY2UodHJlZSk7XHJcbiAgaWYgKCFvcHRpb25zLnByb2plY3QpIHtcclxuICAgIG9wdGlvbnMucHJvamVjdCA9IE9iamVjdC5rZXlzKHdvcmtzcGFjZS5wcm9qZWN0cylbMF07XHJcbiAgfVxyXG4gIGNvbnN0IHByb2plY3QgPSB3b3Jrc3BhY2UucHJvamVjdHNbb3B0aW9ucy5wcm9qZWN0XTtcclxuICBcclxuICBpZiAoIXByb2plY3QuYXJjaGl0ZWN0IHx8ICFwcm9qZWN0LmFyY2hpdGVjdC5idWlsZCB8fCAhcHJvamVjdC5hcmNoaXRlY3QuYnVpbGQub3B0aW9ucykge1xyXG4gICAgcmV0dXJuIG5vb3AoKTtcclxuICB9XHJcblxyXG4gIGNvbnN0IGJ1aWxkT3B0aW9ucyA9IHByb2plY3QuYXJjaGl0ZWN0LmJ1aWxkLm9wdGlvbnMgYXMgQnJvd3NlckJ1aWxkZXJCYXNlT3B0aW9ucztcclxuXHJcbiAgaWYgKCFidWlsZE9wdGlvbnMpIHJldHVybiBub29wKCk7XHJcbiAgXHJcbiAgaWYgKCFidWlsZE9wdGlvbnMuc2NyaXB0cykge1xyXG4gICAgYnVpbGRPcHRpb25zLnNjcmlwdHMgPSBbXTtcclxuICB9XHJcbiAgXHJcbiAgY29uc3Qgc2NyaXB0cyA9IGJ1aWxkT3B0aW9ucy5zY3JpcHRzO1xyXG4gIFxyXG4gIFNDUklQVFNcclxuICAgIC5maWx0ZXIocyA9PiAhc2NyaXB0cy5pbmNsdWRlcyhzKSlcclxuICAgIC5mb3JFYWNoKHNjcmlwdCA9PiB7XHJcbiAgICAgIHNjcmlwdHMucHVzaChzY3JpcHQpO1xyXG4gICAgfSk7XHJcblxyXG4gIHJldHVybiB1cGRhdGVXb3Jrc3BhY2Uod29ya3NwYWNlKTtcclxuXHJcbn1cclxuXHJcbmZ1bmN0aW9uIGdldFByb2plY3QodHJlZTogVHJlZSwgb3B0aW9uczogYW55KSB7XHJcbiAgY29uc3Qgd29ya3NwYWNlID0gZ2V0V29ya3NwYWNlKHRyZWUpO1xyXG4gIGlmICghb3B0aW9ucy5wcm9qZWN0KSB7XHJcbiAgICBvcHRpb25zLnByb2plY3QgPSBPYmplY3Qua2V5cyh3b3Jrc3BhY2UucHJvamVjdHMpWzBdO1xyXG4gIH1cclxuICBjb25zdCBwcm9qZWN0ID0gd29ya3NwYWNlLnByb2plY3RzW29wdGlvbnMucHJvamVjdF07XHJcblxyXG4gIC8vIGNvbXBlbnNhdGUgZm9yIGxhY2tpbmcgc291cmNlUm9vdCBwcm9wZXJ0eVxyXG4gIC8vIGUuIGcuIHdoZW4gcHJvamVjdCB3YXMgbWlncmF0ZWQgdG8gbmc3LCBzb3VyY2VSb290IGlzIGxhY2tpbmdcclxuICBpZiAoIXByb2plY3Quc291cmNlUm9vdCAmJiAhcHJvamVjdC5yb290KSB7XHJcbiAgICBwcm9qZWN0LnNvdXJjZVJvb3QgPSAnc3JjJztcclxuICB9XHJcbiAgZWxzZSBpZiAoIXByb2plY3Quc291cmNlUm9vdCkge1xyXG4gICAgcHJvamVjdC5zb3VyY2VSb290ID0gcGF0aC5qb2luKHByb2plY3Qucm9vdCwgJ3NyYycpO1xyXG4gIH1cclxuXHJcbiAgcmV0dXJuIHByb2plY3Q7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIHNhdmVQYWNrYWdlSnNvbihjb25maWc6IGFueSwgdHJlZTogVHJlZSkge1xyXG4gIGNvbnN0IG5ld0NvbnRlbnRBc1N0cmluZyA9IEpTT04uc3RyaW5naWZ5KGNvbmZpZywgbnVsbCwgMikgfHwgJyc7XHJcbiAgdHJlZS5vdmVyd3JpdGUoJ3BhY2thZ2UuanNvbicsIG5ld0NvbnRlbnRBc1N0cmluZyk7XHJcbn1cclxuXHJcbmZ1bmN0aW9uIGxvYWRQYWNrYWdlSnNvbih0cmVlOiBUcmVlKSB7XHJcbiAgY29uc3QgcGtnID0gdHJlZS5yZWFkKCdwYWNrYWdlLmpzb24nKTtcclxuICBpZiAocGtnID09PSBudWxsKVxyXG4gICAgdGhyb3cgRXJyb3IoJ2NvdWxkIG5vdCByZWFkIHBhY2thZ2UuanNvbicpO1xyXG4gIGNvbnN0IGNvbnRlbnRBc1N0cmluZyA9IHBrZy50b1N0cmluZygnVVRGLTgnKTtcclxuICBjb25zdCBjb25maWcgPSBKU09OLnBhcnNlKGNvbnRlbnRBc1N0cmluZyk7XHJcbiAgcmV0dXJuIGNvbmZpZztcclxufVxyXG5cclxuZnVuY3Rpb24gdXBkYXRlU2NyaXB0cyhwYXRoOiBzdHJpbmcsIGNvbmZpZzogYW55LCB0cmVlOiBUcmVlLCBfb3B0aW9uczogYW55LCBfY29udGV4dDogU2NoZW1hdGljQ29udGV4dCkge1xyXG4gIGNvbnN0IHByb2plY3QgPSBnZXRQcm9qZWN0KHRyZWUsIF9vcHRpb25zKTtcclxuICBcclxuICBpZiAocGF0aCkgcGF0aCArPSAnLyc7XHJcblxyXG4gIGlmICghY29uZmlnWydzY3JpcHRzJ10pIHtcclxuICAgIGNvbmZpZy5zY3JpcHRzID0ge307XHJcbiAgfVxyXG5cclxuICBsZXQgYWRkaXRpb25hbEZsYWdzID0gJyc7XHJcblxyXG4gIC8vIEl2eSBzdXBwb3J0XHJcbiAgY29uc3QgcG9zdEluc3RhbGw6IHN0cmluZyA9IGNvbmZpZy5zY3JpcHRzWydwb3N0aW5zdGFsbCddIHx8ICcnO1xyXG4gIC8vaWYgKHBvc3RJbnN0YWxsLnN0YXJ0c1dpdGgoJ25nY2MnKSkge1xyXG4gICAgY29uZmlnLnNjcmlwdHNbJ3Bvc3RpbnN0YWxsOmJhayddID0gcG9zdEluc3RhbGw7XHJcbiAgICBjb25maWcuc2NyaXB0c1sncG9zdGluc3RhbGwnXSA9ICduZ2NjJztcclxuXHJcbiAgICBfY29udGV4dC5hZGRUYXNrKG5ldyBSdW5TY2hlbWF0aWNUYXNrKCducG1SdW4nLCB7c2NyaXB0OiAncG9zdGluc3RhbGwnfSkpO1xyXG4gIC8vfSBcclxuXHJcbiAgaWYgKCFfb3B0aW9ucy5ob3N0KSB7XHJcbiAgICAvLyBleHRlcm5hbCB3ZWIgY29tcG9uZW50cyBuZWVkIHNpbmdsZSBidW5kbGUgXHJcbiAgICBhZGRpdGlvbmFsRmxhZ3MgPSAnLS1zaW5nbGUtYnVuZGxlJztcclxuICB9XHJcblxyXG4gIC8vIEhldXJpc3RpYyBmb3IgZGVmYXVsdCBwcm9qZWN0XHJcbiAgaWYgKCFwcm9qZWN0LnJvb3QpIHtcclxuICAgIGNvbmZpZy5zY3JpcHRzWydidWlsZDpleHRlcm5hbHMnXSA9IGBuZyBidWlsZCAtLWV4dHJhLXdlYnBhY2stY29uZmlnICR7cGF0aH13ZWJwYWNrLmV4dGVybmFscy5qcyAtLXByb2QgJHthZGRpdGlvbmFsRmxhZ3N9YDtcclxuICB9XHJcblxyXG4gIGlmIChfb3B0aW9ucy5wcm9qZWN0KSB7XHJcbiAgICBjb25maWcuc2NyaXB0c1tgYnVpbGQ6JHtfb3B0aW9ucy5wcm9qZWN0fTpleHRlcm5hbHNgXSA9IGBuZyBidWlsZCAtLWV4dHJhLXdlYnBhY2stY29uZmlnICR7cGF0aH13ZWJwYWNrLmV4dGVybmFscy5qcyAtLXByb2QgLS1wcm9qZWN0ICR7X29wdGlvbnMucHJvamVjdH0gJHthZGRpdGlvbmFsRmxhZ3N9YDtcclxuICB9XHJcbn0iXX0=